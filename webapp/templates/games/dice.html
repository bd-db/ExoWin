{% extends "base.html" %}

{% block title %}Dice Game{% endblock %}

{% block extra_css %}
<style>
    .dice-container {
        text-align: center;
        padding: 20px;
    }
    
    .dice-controls {
        margin: 20px 0;
    }
    
    .target-slider {
        width: 100%;
        margin: 10px 0;
    }
    
    .bet-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }
    
    .dice-result {
        font-size: 3em;
        margin: 20px 0;
        padding: 20px;
        border: 2px solid #333;
        border-radius: 10px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .probability-display {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="dice-container">
    <h2>ðŸŽ² Dice Game</h2>
    <p>Roll over or under your target number!</p>
    
    <div class="user-info">
        <p>Balance: <span id="balance">{{ user.balance }}</span> coins</p>
    </div>
    
    <div class="dice-controls">
        <div class="target-control">
            <label for="target">Target Number: <span id="target-display">50</span></label>
            <input type="range" id="target" class="target-slider" min="2" max="98" value="50">
        </div>
        
        <div class="over-under-control">
            <label>
                <input type="radio" name="over_under" value="over" checked> Roll Over
            </label>
            <label>
                <input type="radio" name="over_under" value="under"> Roll Under
            </label>
        </div>
        
        <div class="probability-display">
            <p>Win Chance: <span id="win-chance">49%</span></p>
            <p>Multiplier: <span id="multiplier">1.96x</span></p>
        </div>
    </div>
    
    <div class="bet-controls">
        <input type="number" id="bet-amount" placeholder="Bet amount" min="1" value="10">
        <button id="roll-btn" class="btn btn-primary">ðŸŽ² Roll Dice</button>
    </div>
    
    <div id="dice-result" class="dice-result" style="display: none;">
        <div id="result-number"></div>
        <div id="result-message"></div>
    </div>
    
    <div id="game-message" class="message"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const targetSlider = document.getElementById('target');
    const targetDisplay = document.getElementById('target-display');
    const winChanceDisplay = document.getElementById('win-chance');
    const multiplierDisplay = document.getElementById('multiplier');
    const rollBtn = document.getElementById('roll-btn');
    const betAmountInput = document.getElementById('bet-amount');
    const diceResult = document.getElementById('dice-result');
    const resultNumber = document.getElementById('result-number');
    const resultMessage = document.getElementById('result-message');
    const gameMessage = document.getElementById('game-message');
    
    function updateProbability() {
        const target = parseInt(targetSlider.value);
        const overUnder = document.querySelector('input[name="over_under"]:checked').value;
        
        let winChance;
        if (overUnder === 'over') {
            winChance = (100 - target) / 100;
        } else {
            winChance = (target - 1) / 100;
        }
        
        const multiplier = 0.95 / winChance; // 95% RTP
        
        winChanceDisplay.textContent = Math.round(winChance * 100) + '%';
        multiplierDisplay.textContent = multiplier.toFixed(2) + 'x';
        targetDisplay.textContent = target;
    }
    
    targetSlider.addEventListener('input', updateProbability);
    document.querySelectorAll('input[name="over_under"]').forEach(radio => {
        radio.addEventListener('change', updateProbability);
    });
    
    rollBtn.addEventListener('click', async () => {
        const betAmount = parseFloat(betAmountInput.value);
        const target = parseInt(targetSlider.value);
        const overUnder = document.querySelector('input[name="over_under"]:checked').value;
        
        if (!betAmount || betAmount <= 0) {
            showMessage('Please enter a valid bet amount', 'error');
            return;
        }
        
        rollBtn.disabled = true;
        rollBtn.textContent = 'ðŸŽ² Rolling...';
        
        // Play dice roll sound
        window.gambleAPI.playSound('dice_roll', 0.5);
        
        try {
            const response = await fetch('/api/game/bet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: getUserId(),
                    game_type: 'dice',
                    bet_amount: betAmount,
                    game_data: {
                        target: target,
                        over_under: overUnder
                    }
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show result
                resultNumber.textContent = data.result.roll;
                resultMessage.textContent = data.result.message;
                diceResult.style.display = 'block';
                
                // Update balance
                document.getElementById('balance').textContent = data.new_balance;
                
                if (data.result.outcome === 'win') {
                    window.gambleAPI.playSound('win', 0.5);
                    showMessage(`ðŸŽ‰ You won ${data.result.winnings} coins!`, 'success');
                } else {
                    window.gambleAPI.playSound('lose', 0.5);
                    showMessage('ðŸ˜” Better luck next time!', 'error');
                }
            } else {
                showMessage(data.error, 'error');
            }
        } catch (error) {
            showMessage('Network error. Please try again.', 'error');
        }
        
        rollBtn.disabled = false;
        rollBtn.textContent = 'ðŸŽ² Roll Dice';
    });
    
    // Initialize probability display
    updateProbability();
</script>
{% endblock %}